<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test R√°pido - Candelas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .oficio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border-radius: 6px;
            border-bottom: 2px solid #e0e0e0;
        }
        .candela-toggle {
            width: 22px;
            height: 22px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .candela-toggle:hover {
            transform: scale(1.2);
            filter: drop-shadow(0 2px 6px rgba(255,215,0,0.8));
        }
        .success { color: green; }
        .error { color: red; }
        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>üî• Test de Candelas - Sistema de Oficios Populares</h1>
        <p><strong>Estado:</strong> <span id="status">Cargando...</span></p>
        
        <h3>Verificaciones:</h3>
        <div id="checks"></div>

        <h3>Oficios de prueba:</h3>
        <div id="oficios-lista"></div>

        <h3>Logs de consola:</h3>
        <div id="log-area" class="log-area"></div>
    </div>

    <script>
        // Interceptar console.log
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logArea = document.getElementById('log-area');
            if (logArea) {
                logArea.innerHTML += args.join(' ') + '<br>';
                logArea.scrollTop = logArea.scrollHeight;
            }
        };

        async function runTests() {
            const checksDiv = document.getElementById('checks');
            const statusSpan = document.getElementById('status');
            const oficiosDiv = document.getElementById('oficios-lista');
            
            console.log('üî• Iniciando tests...');

            // Test 1: Verificar im√°genes
            console.log('üì∏ Verificando im√°genes de candelas...');
            const img0 = new Image();
            const img1 = new Image();
            
            img0.src = '/camella.com.co/assets/images/app/candela0.png';
            img1.src = '/camella.com.co/assets/images/app/candela1.png';
            
            img0.onload = () => console.log('‚úÖ candela0.png existe');
            img0.onerror = () => console.log('‚ùå candela0.png NO encontrada');
            
            img1.onload = () => console.log('‚úÖ candela1.png existe');
            img1.onerror = () => console.log('‚ùå candela1.png NO encontrada');

            // Test 2: Verificar endpoint
            console.log('üì° Verificando endpoint OficioController...');
            try {
                const response = await fetch('/camella.com.co/controllers/OficioController.php?action=togglePopular&id=1');
                console.log('üì• Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üì¶ Data:', JSON.stringify(data, null, 2));
                    statusSpan.innerHTML = '<span class="success">‚úÖ Sistema funcionando</span>';
                } else {
                    statusSpan.innerHTML = '<span class="error">‚ùå Error HTTP: ' + response.status + '</span>';
                }
            } catch (error) {
                console.log('‚ùå Error:', error.message);
                statusSpan.innerHTML = '<span class="error">‚ùå Error de conexi√≥n</span>';
            }

            // Crear oficios de ejemplo
            console.log('üèóÔ∏è Creando oficios de ejemplo...');
            const oficiosEjemplo = [
                { id: 1, nombre: 'Plomero', popular: 1 },
                { id: 2, nombre: 'Electricista', popular: 0 },
                { id: 3, nombre: 'Carpintero', popular: 1 }
            ];

            oficiosEjemplo.forEach(oficio => {
                const item = document.createElement('div');
                item.className = 'oficio-item';
                item.innerHTML = `
                    <span>${oficio.nombre}</span>
                    <img 
                        src="/camella.com.co/assets/images/app/${oficio.popular == 1 ? 'candela1.png' : 'candela0.png'}"
                        class="candela-toggle"
                        data-id="${oficio.id}"
                        data-popular="${oficio.popular}"
                        title="Clic para toggle">
                `;
                oficiosDiv.appendChild(item);
            });

            // Agregar event listeners
            document.querySelectorAll('.candela-toggle').forEach(img => {
                img.addEventListener('click', async function() {
                    const id = this.dataset.id;
                    console.log('üî• Clic en oficio ID:', id);
                    
                    this.style.opacity = '0.5';
                    
                    try {
                        const response = await fetch(`/camella.com.co/controllers/OficioController.php?action=togglePopular&id=${id}`);
                        const data = await response.json();
                        
                        if (data.success) {
                            const nuevaImg = data.newState == 1 ? 'candela1.png' : 'candela0.png';
                            this.src = `/camella.com.co/assets/images/app/${nuevaImg}`;
                            this.dataset.popular = data.newState;
                            this.style.opacity = data.newState == 1 ? '1' : '0.5';
                            console.log('‚úÖ Actualizado a estado:', data.newState);
                        }
                    } catch (error) {
                        console.log('‚ùå Error:', error.message);
                        this.style.opacity = '1';
                    }
                });
            });

            console.log('‚úÖ Tests completados');
        }

        runTests();
    </script>
</body>
</html>
