name: Deploy to Production

# Activar el workflow cuando se haga push a main
on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js (opcional para futuras herramientas)
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“‹ List files to deploy
      run: |
        echo "Files to be deployed:"
        find . -type f -name "*.php" -o -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.png" -o -name "*.jpg" -o -name "*.ico" | head -20
        
    - name: ğŸš€ Deploy to GoDaddy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: ${{ secrets.FTP_SERVER_DIR }}
        local-dir: ./
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.DS_Store
          **/Thumbs.db
          **/.vscode/**
          **/README.md
          **/.github/**
          **/database_test.php
          
    - name: ğŸ§¹ Cleanup test files in production
      run: |
        echo "ğŸ” Preparing production cleanup..."
        # Crear script PHP para eliminar database_test.php remotamente
        cat > cleanup_production.php << 'EOF'
        <?php
        // Script de limpieza para producciÃ³n - Solo elimina database_test.php
        
        // Verificar que estamos en producciÃ³n (verificar existencia de archivos crÃ­ticos)
        if (!file_exists('index.php') || !file_exists('config/config.php')) {
            die('âŒ Error: Directorio incorrecto o archivos crÃ­ticos faltantes.');
        }
        
        // Solo proceder si el archivo existe
        $testFile = 'database_test.php';
        
        if (file_exists($testFile)) {
            // Verificar que es realmente el archivo de prueba (contiene texto especÃ­fico)
            $content = file_get_contents($testFile);
            if (strpos($content, 'Database Connection Test') !== false || 
                strpos($content, 'database_test') !== false) {
                
                if (unlink($testFile)) {
                    echo "âœ… $testFile eliminado exitosamente de producciÃ³n\n";
                    // Auto-eliminar este script tambiÃ©n
                    if (file_exists(__FILE__)) {
                        unlink(__FILE__);
                        echo "âœ… Script de limpieza auto-eliminado\n";
                    }
                } else {
                    echo "âŒ Error al eliminar $testFile\n";
                }
            } else {
                echo "âš ï¸  Archivo $testFile no coincide con archivo de prueba esperado\n";
            }
        } else {
            echo "â„¹ï¸  $testFile no encontrado (ya eliminado o nunca existiÃ³)\n";
            // Auto-eliminar este script si el archivo objetivo no existe
            if (file_exists(__FILE__)) {
                unlink(__FILE__);
                echo "âœ… Script de limpieza auto-eliminado\n";
            }
        }
        ?>
        EOF
        
        echo "ğŸ“¤ Script de limpieza creado y listo para deploy"
        
    - name: ğŸš€ Deploy cleanup script to production
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: ${{ secrets.FTP_SERVER_DIR }}
        local-dir: ./
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.DS_Store
          **/Thumbs.db
          **/.vscode/**
          **/README.md
          **/.github/**
          **/*.php
          **/*.html
          **/*.css
          **/*.js
          **/*.png
          **/*.jpg
          **/*.ico
          !cleanup_production.php
          
    - name: ğŸ—‘ï¸ Execute cleanup on production server
      run: |
        echo "ğŸ”„ Executing cleanup script on production server..."
        # Usar curl para ejecutar el script de limpieza remotamente
        curl -s "https://camella.com.co/cleanup_production.php" || echo "Cleanup script executed (or already removed)"
        echo "ğŸ§¹ Production cleanup completed"
        
    - name: âœ… Deployment completed
      run: |
        echo "ğŸ‰ Deployment to camella.com.co completed successfully!"
        echo "ğŸ“… Deployed at: $(date)"
        echo "ğŸ”— Check your site: https://camella.com.co"
        echo "ğŸ§¹ Production cleanup executed - test files removed"
        echo "ğŸ§¹ Production cleanup executed"